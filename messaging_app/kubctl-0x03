#!/bin/bash
# kubctl-0x03: Rolling update script

set -e

echo "Applying updated blue deployment..."
kubectl apply -f blue_deployment.yaml

echo "Checking rollout status..."
kubectl rollout status deployment/messaging-app-deployment

echo "Testing service availability during rollout..."
SERVICE_URL=$(minikube service messaging-app-service --url)

echo "Sending continuous requests to $SERVICE_URL..."
for i in {1..10}; do
  curl -s -o /dev/null -w "%{http_code}\n" $SERVICE_URL
  sleep 2
done

echo "Verifying new pods..."
kubectl get pods -l app=messaging-app

